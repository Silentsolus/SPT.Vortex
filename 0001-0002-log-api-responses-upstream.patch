From 3304f5880a3fd7af9ab56a251d7ab36a34acf1f8 Mon Sep 17 00:00:00 2001
From: Silentsolus <darkcitrine@gmail.com>
Date: Sun, 1 Feb 2026 05:57:59 +0100
Subject: [PATCH 1/2] ForgeApiService: add response logging helper and replace
 response reads

---
 Services/ForgeApiService.cs | 38 +++++++++++++++++++++++++++++--------
 1 file changed, 30 insertions(+), 8 deletions(-)

diff --git a/Services/ForgeApiService.cs b/Services/ForgeApiService.cs
index a7fbcb7..06eed06 100644
--- a/Services/ForgeApiService.cs
+++ b/Services/ForgeApiService.cs
@@ -30,6 +30,28 @@ public partial class ForgeApiService(
 
     private static readonly JsonSerializerOptions _jsonOptions = new() { PropertyNameCaseInsensitive = true };
 
+    // Helper to truncate large response bodies when logging
+    private static string TruncateForLog(string s, int max = 32000)
+    {
+        if (s is null) return string.Empty;
+        return s.Length <= max ? s : s.Substring(0, max) + "... (truncated)";
+    }
+
+    // Safe wrapper to read the response body and log it (Debug, truncated).
+    private async Task<string> GetJsonResponseStringAsync(HttpResponseMessage response, string url, CancellationToken cancellationToken)
+    {
+        var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
+        try
+        {
+            logger.LogDebug("API Response: {Url}: {Body}", url, TruncateForLog(jsonContent));
+        }
+        catch (Exception ex)
+        {
+            logger.LogDebug(ex, "Failed to log API response for {Url}", url);
+        }
+        return jsonContent;
+    }
+
     /// <summary>
     /// A regular expression to convert camelCase strings to space-separated words.
     /// </summary>
@@ -155,7 +177,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var authResponse = JsonSerializer.Deserialize<AuthAbilitiesResponse>(jsonContent, _jsonOptions);
             var hasReadPermission =
                 authResponse is { Success: true, Data: not null } && authResponse.Data.Contains("read");
@@ -212,7 +234,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var apiResponse = JsonSerializer.Deserialize<SptVersionApiResponse>(jsonContent, _jsonOptions);
 
             var isValid =
@@ -266,7 +288,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var apiResponse = JsonSerializer.Deserialize<SptVersionApiResponse>(jsonContent, _jsonOptions);
 
             return apiResponse is { Success: true, Data: not null } ? apiResponse.Data : [];
@@ -360,7 +382,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var jsonDoc = JsonDocument.Parse(jsonContent);
 
             if (
@@ -427,7 +449,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var apiResponse = JsonSerializer.Deserialize<ModSearchApiResponse>(jsonContent, _jsonOptions);
 
             if (apiResponse is not { Success: true, Data.Count: > 0 })
@@ -507,7 +529,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var apiResponse = JsonSerializer.Deserialize<ModSearchApiResponse>(jsonContent, _jsonOptions);
 
             return apiResponse is { Success: true, Data: not null } ? apiResponse.Data : [];
@@ -562,7 +584,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var apiResponse = JsonSerializer.Deserialize<ModUpdatesApiResponse>(jsonContent, _jsonOptions);
 
             if (apiResponse?.Success != true || apiResponse.Data is null)
@@ -620,7 +642,7 @@ public partial class ForgeApiService(
                 return new ApiError($"API returned status {response.StatusCode}", (int)response.StatusCode);
             }
 
-            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
+            var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
             var apiResponse = JsonSerializer.Deserialize<ModDependenciesApiResponse>(jsonContent, _jsonOptions);
 
             if (apiResponse?.Success != true || apiResponse.Data is null)
-- 
2.52.0.windows.1


From 42ad3c4331546d93e24965cd222b1ab7e8e7f0c9 Mon Sep 17 00:00:00 2001
From: Silentsolus <darkcitrine@gmail.com>
Date: Sun, 1 Feb 2026 05:59:32 +0100
Subject: [PATCH 2/2] ForgeApiService: fix helper recursion

---
 Services/ForgeApiService.cs | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/Services/ForgeApiService.cs b/Services/ForgeApiService.cs
index 06eed06..047c69f 100644
--- a/Services/ForgeApiService.cs
+++ b/Services/ForgeApiService.cs
@@ -40,7 +40,7 @@ public partial class ForgeApiService(
     // Safe wrapper to read the response body and log it (Debug, truncated).
     private async Task<string> GetJsonResponseStringAsync(HttpResponseMessage response, string url, CancellationToken cancellationToken)
     {
-        var jsonContent = await GetJsonResponseStringAsync(response, url, cancellationToken);
+        var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);
         try
         {
             logger.LogDebug("API Response: {Url}: {Body}", url, TruncateForLog(jsonContent));
-- 
2.52.0.windows.1

